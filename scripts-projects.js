/* eslint-disable max-len */
// eslint-disable-next-line @typescript-eslint/no-var-requires
const utils = require("nps-utils");
const { workspaces } = require("./package.json");
const configFile = "";

const getConcurrent = (args) => utils.concurrent.nps(...args);

const getScripts = (packages) => {
  const getScript = (package, command) => {
    return package
      ? `npx lerna run ${command} --scope ${package}`
      : getConcurrent(packages.map((pkg) => `${command}.${pkg} --config=./scripts-projects.js`))
          .split('projects.js"') // need to remove " symbols from commands generated by 'concurrent' command,
          .join("projects.js")
          .split('projects.js"') // twice for windows %)
          .join("projects.js")
          .split('nps "')
          .join("nps ")
          .split('nps "')
          .join("nps ");
  };

  const setCommand = (command) =>
    packages.reduce((a, c) => ({ ...a, [`${c}`]: getScript(c, command) }), {
      default: getScript(undefined, command),
    });

  return { setCommand };
};

const getScriptsSection = (packages) => {
  const { setCommand } = getScripts(packages);

  return {
    scripts: {
      build: setCommand("build"),
      test: setCommand("test"),
      "start:dev": setCommand("start:dev"),
      lint: setCommand("lint"),
      "lint:fix": setCommand("lint:fix"),
    },
  };
};

workspaces.shift();
module.exports = getScriptsSection(workspaces.map((x) => x.replace("/*", "")));
